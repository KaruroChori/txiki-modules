> [!WARNING]  
> This documentation has not been fully written yet.

> [!IMPORTANT]  
> If you want to test txiki modules you will have to use a separate branch since it has not been merged yet.
> [this](https://github.com/KaruroChori/txiki.js/tree/stable-gluegunfw) contains the module feature alongide few more patches.

## What are txiki modules?

External modules are a mechanism to define custom runtimes based on Txiki.  
Any external module specified as a requirement will be integrated within the native build process of Txiki; this way, any bundle, artefact or documentation can be generated, exposed & tested alongside.  
Txiki modules are mostly independent of each other, and kept separate from the main basecode; as such, we can add core functionality in txiki without the hassle of maintaining a divergent branch.  
External modules are specifically designed not to interfere with the original repo content, and any file generated because of them will not be tracked.

For more context on why they exists, you can refer to https://github.com/saghul/txiki.js/discussions/514.

## Getting started

To start using txiki modules you need to create a json file **outside** the txiki repository. For example `modules.json` in its parent folder.  
You can have a file `modules.json` inside the repo, and that is the default location that most cli commands will assume, but such file is meant to be generated by some wrapper script or automatically copied over before usage, as it will not be tracked.

The `modules.json` file should follow the schema described in `/schemas/src/modules.schema.ts`. For example:

```json
{
  "demo": "https://github.com/KaruroChori/demo-txiki-module/releases/download/v2.1.0/module.tar.gz"
}
```

Entries can either point to a filesystem location, or to `tar.gz` file online.  
There are precise specifications on how any folder or archive should be organized.

At this point, you can either run `bun run extra-modules-clone ../modules.json` or any of its alternatives to automatically retrieve and apply modules to the main repo.  
The `./extra-helper.mjs` script offers few more commands and options documented via `--help`.

Now you just build the runtime as you always did, and you get the interface and functionality of the `demo` module exposed as part of its core features.

## Features

### Basic features

- [x] Automatic module retrieval via fs and URI.
- [x] Module types and documentation as we already have from the core code.
- [x] Native dependencies retrieved, built and linked (more testing needed).
- [x] Command to refresh a single module.

### Future improvements

- [ ] Peer module dependencies. Supported in the schema, so they can be specified, but they are not enforced or tested yet by the helper script yet.
- [ ] Checks on versions for both the runtime and the schema format. Some boilerplate has been implemented, but no action is taken yet.
- [ ] Schema validation. Since we now have proper schemas for `module.json` and `module.schema.json` it would be nice to enforce them.
- [ ] Some caching. At the moment the `clone` command will fully refresh all modules from scratch.

## How to make custom modules?

WIP  
Reference repository for a [demo module](https://github.com/KaruroChori/demo-txiki-module) to get started.  
Some pointers on how to port existing JS libraries as modules can be found [here](./docs/how-to-port.md).

## Resources

List of available modules is [here](./docs/modules.md).

JSON schemas for the `module.json` and `modules.json` files are distributed as artefacts of each release in this repo.  
Otherwise, they can be generated via the `gen-schemas` script.  
Or if your application allows that, you can directly use the typebox-based schemas from which they are generated.
